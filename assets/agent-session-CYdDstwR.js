import{i as l,a as w,b as p,w as A,c as M,d as o,e as d,f as T,D as v,j as b,k as m,P as x,l as f,s as D,h as k,F as R,S as I,M as g,m as P,n as F,o as C,p as O,q as E,r as _}from"./index-DYkS4CO9.js";import{d as N}from"./invoke-DVkn7oSR.js";class y{constructor(e,t){if(!e.onEnd)throw new Error("onEnd handler is required");if(!t)throw new Error("ms duration is required");this.onEnd=e.onEnd,this.initialMs=t,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,t)}create(e,t){return this.timer&&this.clear(),setTimeout(()=>e?e():this.onEnd(),t||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}class U extends y{constructor(e,t){var s;super(e,t),this.onPause=typeof e.onPause=="function"?e.onPause:()=>{},this.onRefresh=typeof e.onRefresh=="function"?e.onRefresh:()=>{},this.onResume=typeof e.onResume=="function"?e.onResume:()=>{},this.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch{}if(l&&e.ee){if(e.ee){this.ee=e.ee;const r=N(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=i=>{var a;e.refreshEvents.includes((a=i==null?void 0:i[0])==null?void 0:a.type)&&r()},e.ee.on("fn-end",this.refreshHandler)}w(r=>{r==="hidden"?this.pause():this.resume()},!1,!1,(s=this.abortController)==null?void 0:s.signal)}}abort(){var e;this.clear(),(e=this.abortController)==null||e.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){this.refresh(),this.onResume()}refresh(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}const h={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:g.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:g.OFF,traceHarvestStarted:!1,custom:{}};class j{constructor(e){const{agentIdentifier:t,key:s,storage:r}=e;if(!t||!s||!r)throw new Error("Missing required field(s):".concat(t?"":" agentID").concat(s?"":" key").concat(r?"":" storage"));this.agentIdentifier=t,this.storage=r,this.state={},this.key=s,this.ee=p.get(t),A(this.ee),this.setup(e),l&&M("storage",i=>{if(i.key===this.lookupKey){const a=typeof i.newValue=="string"?JSON.parse(i.newValue):i.newValue;this.sync(a),this.ee.emit(o.UPDATE,[d.CROSS_TAB,this.state])}})}setup(e){let{value:t=T(16),expiresMs:s=v,inactiveMs:r=b}=e;this.state={},this.sync(h),this.state.value=t,this.expiresMs=s,this.inactiveMs=r;const i=this.read();s?(this.state.expiresAt=(i==null?void 0:i.expiresAt)||this.getFutureTimestamp(s),this.expiresTimer=new y({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,r?(this.state.inactiveAt=(i==null?void 0:i.inactiveAt)||this.getFutureTimestamp(r),this.inactiveTimer=new U({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(o.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(o.PAUSE),this.write(m(this.state,h))},ee:this.ee,refreshEvents:["click","keydown","scroll"]},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew||(this.isNew=!Object.keys(i).length),this.isNew?this.write(m(this.state,h),!0):this.sync(i),this.initialized=!0}get lookupKey(){return"".concat(x,"_").concat(this.key)}sync(e){Object.assign(this.state,e)}read(){try{const e=this.storage.get(this.lookupKey);if(!e)return{};const t=typeof e=="string"?JSON.parse(e):e;return this.isInvalid(t)?{}:this.isExpired(t.expiresAt)?(this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset()):this.isExpired(t.inactiveAt)?(this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset()):t}catch(e){return f("Failed to read from storage API",e),{}}}write(e){try{return!e||typeof e!="object"?void 0:(e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,D(this.state)),this.ee.emit(o.UPDATE,[d.SAME_TAB,this.state]),e)}catch(t){return f("Failed to write to the storage API",t),null}}reset(){var e,t,s,r;try{return this.initialized&&this.ee.emit(o.RESET),this.storage.remove(this.lookupKey),(t=(e=this.inactiveTimer)==null?void 0:e.abort)==null||t.call(e),(r=(s=this.expiresTimer)==null?void 0:s.clear)==null||r.call(s),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs}),this.read()}catch{return{}}}refresh(){const e=this.read();this.write({...e,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isExpired(e){return Date.now()>e}isInvalid(e){return!Object.keys(h).every(s=>Object.keys(e).includes(s))}collectSM(e,t,s){let r,i;e==="duration"&&(r=this.getDuration(t,s),i="Session/Duration/Ms"),e==="expired"&&(i="Session/Expired/Seen"),e==="inactive"&&(i="Session/Inactive/Seen"),i&&k(I,[i,r],void 0,R.metrics,this.ee)}getDuration(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.state,t=arguments.length>1?arguments[1]:void 0;const s=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-s}getFutureTimestamp(e){return Date.now()+e}syncCustomAttribute(e,t){if(l)if(t===null){const s=this.read();s.custom&&(delete s.custom[e],this.write({...s}))}else{const s=this.read();this.custom={...(s==null?void 0:s.custom)||{},[e]:t},this.write({...s,custom:this.custom})}}}class H{get(e){try{return localStorage.getItem(e)||void 0}catch{return""}}set(e,t){try{return t==null?this.remove(e):localStorage.setItem(e,t)}catch{}}remove(e){try{localStorage.removeItem(e)}catch{}}}class K{constructor(e){this.domain=e}get(e){try{var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));if(t)return t[2]}catch{return""}}set(e,t){try{const s="".concat(e,"=").concat(t,"; Domain=").concat(this.domain,"; Path=/");document.cookie=s}catch{}}remove(e){try{document.cookie="".concat(e,"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; Domain=").concat(this.domain,"; Path=/")}catch{}}}let L=0;function B(n){const e=P(n);if(L++)return e.session;const t=F(n).session,s=t!=null&&t.domain?new K(t.domain):new H;e.session=new j({agentIdentifier:n,key:C,storage:s,expiresMs:t==null?void 0:t.expiresMs,inactiveMs:t==null?void 0:t.inactiveMs});const r=e.session.state.custom,i=O(n);r&&(i.jsAttributes={...i.jsAttributes,...r});const a=p.get(n);return E("api-setCustomAttribute",(S,c,u)=>{e.session.syncCustomAttribute(c,u)},"session",a),E("api-setUserId",(S,c,u)=>{e.session.syncCustomAttribute(c,u)},"session",a),_(n,"session"),e.session}export{B as setupAgentSession};
