import{ad as z,E as Q,g as F,l as p,a4 as E,i as V,ae as W,z as H,s as T,p as v,m as x,n as $,J as K,af as X,a7 as Z,B as J,ag as G,ah as Y,q as ee,r as te,ai as b,aj as ne}from"./index-DbYqWX7c.js";function se(s){return z(s)}function ae(){var s,e;return((e=(s=Q)==null?void 0:s.location)==null?void 0:e.protocol)==="file:"}var re={regex:/^file:\/\/(.*)/,replacement:atob("ZmlsZTovL09CRlVTQ0FURUQ=")};class ie extends E{shouldObfuscate(){return k(this.sharedContext.agentIdentifier).length>0}obfuscateString(e){if(!e||typeof e!="string")return e;for(var t=k(this.sharedContext.agentIdentifier),n=e,a=0;a<t.length;a++){var r=t[a].regex,i=t[a].replacement||"*";n=n.replace(r,i)}return n}}function k(s){var e=[],t=F(s,"obfuscate")||[];return e=e.concat(t),ae()&&e.push(re),e}function ve(s){for(var e=!1,t=!1,n=0;n<s.length;n++){"regex"in s[n]?typeof s[n].regex!="string"&&!(s[n].regex instanceof RegExp)&&(p('An obfuscation replacement rule contains a "regex" value with an invalid type (must be a string or RegExp)'),t=!0):(p('An obfuscation replacement rule was detected missing a "regex" value.'),t=!0);var a=s[n].replacement;a&&typeof a!="string"&&(p('An obfuscation replacement rule contains a "replacement" value with an invalid type (must be a string)'),e=!0)}return!e&&!t}/**
 * @file Contains common methods used to transmit harvested data.
 * @copyright 2023 New Relic Corporation. All rights reserved.
 * @license Apache-2.0
 */function q(){let{isFinalHarvest:s=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return s&&V&&W?oe:R}function R(s){let{url:e,body:t=null,sync:n,method:a="POST",headers:r=[{key:"content-type",value:"text/plain"}]}=s;const i=new XMLHttpRequest;i.open(a,e,!n);try{"withCredentials"in i&&(i.withCredentials=!0)}catch{}return r.forEach(o=>{i.setRequestHeader(o.key,o.value)}),i.send(t),i}function oe(s){let{url:e,body:t}=s;try{return window.navigator.sendBeacon.bind(window.navigator)(e,t)}catch{return!1}}var U={"%2C":",","%3A":":","%2F":"/","%40":"@","%24":"$","%3B":";"},ue=H(U,function(s){return s}),ce=new RegExp(ue.join("|"),"g");function le(s){return U[s]}function C(s){return s==null?"null":encodeURIComponent(s).replace(ce,le)}function fe(s,e){var t=0,n="";return H(s,function(a,r){var i=[],o,c;if(typeof r=="string"||!Array.isArray(r)&&r!==null&&r!==void 0&&r.toString().length)o="&"+a+"="+C(r),t+=o.length,n+=o;else if(Array.isArray(r)&&r.length){for(t+=9,c=0;c<r.length&&(o=C(T(r[c])),t+=o.length,!(typeof e<"u"&&t>=e));c++)i.push(o);n+="&"+a+"=%5B"+i.join(",")+"%5D"}}),n}function l(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return Object.keys(t).includes(s)?"":e&&typeof e=="string"?"&"+s+"="+C(e):""}function de(){return""+location}var ge=/([^?#]*)[^#]*(#[^?]*|$).*/,he=/([^?#]*)().*/;function pe(s,e){return s.replace(e?ge:he,"$1$2")}function _(s,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"string",n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:[];return!s||typeof s!="object"||Object.keys(s).forEach(a=>{typeof s[a]=="object"?_(s[a],e,t,n):typeof s[a]===t&&!n.includes(a)&&(s[a]=e(s[a]))}),s}const h={};class xe extends E{constructor(e){super(e),this.tooManyRequestsDelay=F(this.sharedContext.agentIdentifier,"harvest.tooManyRequestsDelay")||60,this.obfuscator=new ie(this.sharedContext),this._events={}}sendX(){var i,o,c;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=q({isFinalHarvest:(i=e.opts)==null?void 0:i.unload}),n={retry:!((o=e.opts)!=null&&o.unload)&&t===R,isFinalHarvest:((c=e.opts)==null?void 0:c.unload)===!0},a=this.createPayload(e.endpoint,n);return(this.obfuscator.shouldObfuscate()?this.obfuscateAndSend.bind(this):this._send.bind(this))({...e,payload:a,submitMethod:t})}send(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(this.obfuscator.shouldObfuscate()?this.obfuscateAndSend.bind(this):this._send.bind(this))(e)}obfuscateAndSend(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{payload:n={}}=t;return _(n,function(){return e.obfuscator.obfuscateString(...arguments)},"string",["e"]),this._send({...t,payload:n})}_send(e){var O;let{endpoint:t,payload:n={},opts:a={},submitMethod:r,cbFinished:i,customUrl:o,raw:c,includeBaseParams:M=!0}=e;const m=v(this.sharedContext.agentIdentifier);if(!m.errorBeacon)return!1;const N=x(this.sharedContext.agentIdentifier);let{body:u,qs:f}=this.cleanPayload(n);if(Object.keys(u).length===0&&!(a!=null&&a.sendEmptyBody))return i&&i({sent:!1}),!1;const w=$(this.sharedContext.agentIdentifier),I=w.ssl===!1?"http":"https",P=w.proxy.beacon||m.errorBeacon,D=t!=="rum"?"/".concat(t):"";let y="".concat(I,"://").concat(P).concat(D,"/1/").concat(m.licenseKey);o&&(y=o),c&&(y="".concat(I,"://").concat(P,"/").concat(t));const S=!c&&M?this.baseQueryString(f):"";let g=fe(f,N.maxBytes);r||(r=q({isFinalHarvest:a.unload})),S===""&&g.startsWith("&")&&(g=g.substring(1));const L="".concat(y,"?").concat(S).concat(g);!!((O=f==null?void 0:f.attributes)!=null&&O.includes("gzip"))||(t==="events"?u=u.e:u=T(u),u.length>75e4&&(h[t]=((h==null?void 0:h[t])||0)+1)===1&&p("The Browser Agent is attempting to send a very large payload to /".concat(t,". This is usually tied to large amounts of custom attributes. Please check your configurations."))),(!u||u.length===0||u==="{}"||u==="[]")&&(u="");const A=[];A.push({key:"content-type",value:"text/plain"});let B=r({url:L,body:u,sync:a.unload&&(K||X),headers:A});if(!a.unload&&i&&r===R){const j=this;B.addEventListener("loadend",function(){const d={sent:this.status!==0,status:this.status};this.status===429?(d.retry=!0,d.delay=j.tooManyRequestsDelay):(this.status===408||this.status===500||this.status===503)&&(d.retry=!0),a.needResponse&&(d.responseText=this.responseText),i(d)},Z(!1))}return B}baseQueryString(e){var i,o;const t=x(this.sharedContext.agentIdentifier),n=v(this.sharedContext.agentIdentifier),a=pe(de()),r=this.obfuscator.shouldObfuscate()?this.obfuscator.obfuscateString(a):a;return["a="+n.applicationID,l("sa",n.sa?""+n.sa:""),l("v",G),me(n),l("ct",t.customTransaction),"&rst="+J(),"&ck=0","&s="+(((i=t.session)==null?void 0:i.state.value)||"0"),l("ref",r),l("ptid",t.ptid?""+t.ptid:""),l("hr",((o=t==null?void 0:t.session)==null?void 0:o.state.sessionReplayMode)===1?"1":"0",e)].join("")}createPayload(e,t){const n=this._events[e],a={body:{},qs:{}};if(Array.isArray(n)&&n.length>0)for(let r=0;r<n.length;r++){const i=n[r](t);i&&(a.body={...a.body,...i.body||{}},a.qs={...a.qs,...i.qs||{}})}return a}cleanPayload(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=n=>typeof Uint8Array<"u"&&n instanceof Uint8Array||Array.isArray(n)?n:typeof n=="string"?n.length>0?n:null:Object.entries(n||{}).reduce((a,r)=>{let[i,o]=r;return(typeof o=="number"||typeof o=="string"&&o.length>0||typeof o=="object"&&Object.keys(o||{}).length>0)&&(a[i]=o),a},{});return{body:t(e.body),qs:t(e.qs)}}on(e,t){Array.isArray(this._events[e])||(this._events[e]=[]),this._events[e].push(t)}}function me(s){return s.transactionName?l("to",s.transactionName):l("t",s.tNamePlain||"Unnamed Transaction")}class Re extends Y{constructor(){super(...arguments),this.checkConfiguration()}waitForFlags(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];return Promise.all(e.map(t=>new Promise(n=>{ee("rumresp-".concat(t),a=>n(a),this.featureName,this.ee)})))}drain(){te(this.agentIdentifier,this.featureName)}checkConfiguration(){var e,t;if(!se(this.agentIdentifier)){let n={...(e=b().info)==null?void 0:e.jsAttributes};try{n={...n,...(t=v(this.agentIdentifier))==null?void 0:t.jsAttributes}}catch{}ne({agentIdentifier:this.agentIdentifier},{...b(),info:{...b().info,jsAttributes:n},runtime:x(this.agentIdentifier)})}}}export{Re as A,xe as H,ie as O,q as a,pe as c,k as g,ae as i,fe as o,ve as v,R as x};
