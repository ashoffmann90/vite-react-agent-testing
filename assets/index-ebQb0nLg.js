function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/recorder-C-KKxidD.js","assets/index-DzSGQKjV.js","assets/index-BXcBgsTm.css","assets/stylesheet-evaluator-HEZL3CRr.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
var L=Object.defineProperty;var U=(m,t,e)=>t in m?L(m,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):m[t]=e;var I=(m,t,e)=>(U(m,typeof t!="symbol"?t+"":t,e),e);import{X as v,g as N,m as p,M as r,h as d,F as l,S as c,d as _,Y as g,e as k,q as b,Z as C,E as B,_ as w,s as P,$ as D,p as H,R as F,B as W,a0 as V,l as Y,Q as x}from"./index-DzSGQKjV.js";import{H as j}from"./harvest-scheduler-n7W21jAE.js";import{A as q,o as G}from"./aggregate-base-Dw6vXBB8.js";import{s as Q}from"./shared-channel-WhqwlLun.js";import{s as X}from"./stylesheet-evaluator-HEZL3CRr.js";class Z extends q{constructor(t,e,s){super(t,e,v),this.harvestTimeSeconds=N(this.agentIdentifier,"session_replay.harvestTimeSeconds")||60,this.initialized=!1,this.blocked=!1,this.gzipper=void 0,this.u8=void 0;const{session:i}=p(this.agentIdentifier);this.mode=i.state.sessionReplayMode||r.OFF,this.entitled=!1,this.recorder=s==null?void 0:s.recorder,this.recorder&&(this.recorder.parent=this),d(c,["Config/SessionReplay/Enabled"],void 0,l.metrics,this.ee),this.ee.on(_.RESET,()=>{this.scheduler.runHarvest(),this.abort(g.RESET)}),this.ee.on(_.PAUSE,()=>{var n;(n=this.recorder)==null||n.stopRecording()}),this.ee.on(_.RESUME,()=>{var h;if(!this.recorder)return;const{session:n}=p(this.agentIdentifier);this.mode=n.state.sessionReplayMode,!(!this.initialized||this.mode===r.OFF)&&((h=this.recorder)==null||h.startRecording())}),this.ee.on(_.UPDATE,(n,h)=>{!this.recorder||!this.initialized||this.blocked||n!==k.CROSS_TAB||(this.mode!==r.OFF&&h.sessionReplayMode===r.OFF&&this.abort(g.CROSS_TAB),this.mode=h.sessionReplay)}),this.scheduler=new j("browser/blobs",{onFinished:this.onHarvestFinished.bind(this),retryDelay:this.harvestTimeSeconds,getPayload:this.prepareHarvest.bind(this),raw:!0},this),b(C.RECORD,()=>{this.blocked||!this.entitled||(this.recorder?this.mode!==r.FULL&&this.switchToFull():this.initializeRecording(!1,!0,!0))},this.featureName,this.ee),b(C.PAUSE,()=>{this.forceStop(this.mode!==r.ERROR)},this.featureName,this.ee),b("errorAgg",n=>{var h;this.errorNoticed=!0,this.recorder&&(this.recorder.currentBufferTarget.hasError=!0),this.mode===r.ERROR&&((h=B)==null?void 0:h.document.visibilityState)==="visible"&&this.switchToFull()},this.featureName,this.ee);const{error_sampling_rate:o,sampling_rate:a,autoStart:u,block_selector:f,mask_text_selector:S,mask_all_inputs:T,inline_stylesheet:M,inline_images:R,collect_fonts:E}=N(this.agentIdentifier,"session_replay");this.waitForFlags(["sr"]).then(n=>{var y;let[h]=n;if(this.entitled=h,!this.entitled&&((y=this.recorder)!=null&&y.recording)){this.abort(g.ENTITLEMENTS),d(c,["SessionReplay/EnabledNotEntitled/Detected"],void 0,l.metrics,this.ee);return}this.initializeRecording(Math.random()*100<o,Math.random()*100<a)}).then(()=>{var n;this.mode===r.OFF&&((n=s==null?void 0:s.recorder)==null||n.stopRecording()),Q.onReplayReady(this.mode)}),u||d(c,["Config/SessionReplay/AutoStart/Modified"],void 0,l.metrics,this.ee),E===!0&&d(c,["Config/SessionReplay/CollectFonts/Modified"],void 0,l.metrics,this.ee),M!==!0&&d(c,["Config/SessionReplay/InlineStylesheet/Modified"],void 0,l.metrics,this.ee),R===!0&&d(c,["Config/SessionReplay/InlineImages/Modifed"],void 0,l.metrics,this.ee),T!==!0&&d(c,["Config/SessionReplay/MaskAllInputs/Modified"],void 0,l.metrics,this.ee),f!=="[data-nr-block]"&&d(c,["Config/SessionReplay/BlockSelector/Modified"],void 0,l.metrics,this.ee),S!=="*"&&d(c,["Config/SessionReplay/MaskTextSelector/Modified"],void 0,l.metrics,this.ee),d(c,["Config/SessionReplay/SamplingRate/Value",a],void 0,l.metrics,this.ee),d(c,["Config/SessionReplay/ErrorSamplingRate/Value",o],void 0,l.metrics,this.ee),this.drain()}switchToFull(){this.mode=r.FULL,this.recorder&&this.initialized&&(this.recorder.stopRecording(),this.recorder.startRecording(),this.scheduler.startTimer(this.harvestTimeSeconds),this.syncWithSessionManager({sessionReplayMode:this.mode}))}async initializeRecording(t,e,s){var o;if(this.initialized=!0,!this.entitled)return;const{session:i}=p(this.agentIdentifier);if(!i.isNew&&!s)this.mode=i.state.sessionReplayMode;else if(e)this.mode=r.FULL;else if(t)this.mode=r.ERROR;else return;if(((o=this.recorder)==null?void 0:o.getEvents().type)==="preloaded"&&this.prepUtils().then(()=>{this.scheduler.runHarvest()}),!this.recorder)try{const{Recorder:a}=await w(()=>import("./recorder-C-KKxidD.js"),__vite__mapDeps([0,1,2,3]));this.recorder=new a(this),this.recorder.currentBufferTarget.hasError=this.errorNoticed}catch{return this.abort(g.IMPORT)}this.mode===r.ERROR&&this.errorNoticed&&(this.mode=r.FULL),this.mode===r.FULL&&!this.scheduler.started&&this.scheduler.startTimer(this.harvestTimeSeconds),await this.prepUtils(),this.recorder.recording||this.recorder.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}async prepUtils(){try{const{gzipSync:t,strToU8:e}=await w(()=>import("./browser-B3_RsDpH.js"),__vite__mapDeps([]));this.gzipper=t,this.u8=e}catch{}}prepareHarvest(){let{opts:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!this.recorder)return;const e=this.recorder.getEvents();if(!e.events.length||this.mode!==r.FULL||this.blocked)return;const s=this.getHarvestContents(e);if(!s.body.length){this.recorder.clearBuffer();return}let i=0;if(this.gzipper&&this.u8?(s.body=this.gzipper(this.u8("[".concat(s.body.map(a=>a.__serialized).join(","),"]"))),i=s.body.length,this.scheduler.opts.gzip=!0):(s.body=s.body.map(a=>{let{__serialized:u,...f}=a;return f}),i=P(s.body).length,this.scheduler.opts.gzip=!1),i>D){this.abort(g.TOO_BIG);return}const{session:o}=p(this.agentIdentifier);return o.state.sessionReplaySentFirstChunk||this.syncWithSessionManager({sessionReplaySentFirstChunk:!0}),this.recorder.clearBuffer(),e.type==="preloaded"&&this.scheduler.runHarvest(t),[s]}getHarvestContents(t){var n,h,y,A,O;t??(t=this.recorder.getEvents());let e=t.events;const s=p(this.agentIdentifier),i=H(this.agentIdentifier),o=(n=i.jsAttributes)==null?void 0:n["enduser.id"];((h=e==null?void 0:e[0])==null?void 0:h.type)===F.FullSnapshot&&this.recorder.lastMeta&&(t.hasMeta=!0,e.unshift(this.recorder.lastMeta),this.recorder.lastMeta=void 0),((y=e[e.length-1])==null?void 0:y.type)===F.Meta&&(this.recorder.lastMeta=e[e.length-1],e=e.slice(0,e.length-1),t.hasMeta=!!e.find(z=>z.type===F.Meta));const f=p(this.agentIdentifier).offset,S=W(),T=(A=e[0])==null?void 0:A.timestamp,M=(O=e[e.length-1])==null?void 0:O.timestamp,R=T||t.cycleTimestamp,E=M||f+S;return{qs:{browser_monitoring_key:i.licenseKey,type:"SessionReplay",app_id:i.applicationID,protocol_version:"0",attributes:G({...!!this.gzipper&&!!this.u8&&{content_encoding:"gzip"},"replay.firstTimestamp":R,"replay.firstTimestampOffset":R-f,"replay.lastTimestamp":E,"replay.durationMs":E-R,"replay.nodes":e.length,"session.durationMs":s.session.getDuration(),agentVersion:s.version,session:s.session.state.value,rst:S,hasMeta:t.hasMeta||!1,hasSnapshot:t.hasSnapshot||!1,hasError:t.hasError||!1,isFirstChunk:s.session.state.sessionReplaySentFirstChunk===!1,decompressedBytes:t.payloadBytesEstimation,invalidStylesheetsDetected:X.invalidStylesheetsDetected,inlinedAllStylesheets:t.inlinedAllStylesheets,"rrweb.version":V,...o&&{"enduser.id":o}},x).substring(1)},body:e}}onHarvestFinished(t){t.status===429&&this.abort(g.TOO_MANY),this.blocked&&this.scheduler.stopTimer(!0)}forceStop(t){var e,s;t&&this.scheduler.runHarvest(),this.mode=r.OFF,(s=(e=this.recorder)==null?void 0:e.stopRecording)==null||s.call(e),this.syncWithSessionManager({sessionReplayMode:this.mode})}abort(){var e,s,i,o,a,u,f;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};for(Y("SR aborted -- ".concat(t.message)),d(c,["SessionReplay/Abort/".concat(t.sm)],void 0,l.metrics,this.ee),this.blocked=!0,this.mode=r.OFF,(s=(e=this.recorder)==null?void 0:e.stopRecording)==null||s.call(e),this.syncWithSessionManager({sessionReplayMode:this.mode}),(o=(i=this.recorder)==null?void 0:i.clearTimestamps)==null||o.call(i),this.ee.emit("REPLAY_ABORTED");(a=this.recorder)!=null&&a.getEvents().events.length;)(f=(u=this.recorder)==null?void 0:u.clearBuffer)==null||f.call(u)}syncWithSessionManager(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{session:e}=p(this.agentIdentifier);e.write(t)}}I(Z,"featureName",v);export{Z as Aggregate};
