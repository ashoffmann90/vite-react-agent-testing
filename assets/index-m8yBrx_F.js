var q=Object.defineProperty;var z=(e,r,t)=>r in e?q(e,r,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[r]=t;var C=(e,r,t)=>(z(e,typeof r!="symbol"?r+"":r,t),t),$=(e,r,t)=>{if(!r.has(e))throw TypeError("Cannot "+t)};var T=(e,r,t)=>{if(r.has(e))throw TypeError("Cannot add the same private member more than once");r instanceof WeakSet?r.add(e):r.set(e,t)};var E=(e,r,t)=>($(e,r,"access private method"),t);import{x as P,y as F,q as I,g as D,s as g,m as B,z as A,B as G,E as W,h as N,F as b,v as V,p as J}from"./index-BfuMbHu1.js";import{c as O,A as K}from"./aggregate-base-TAWkHkou.js";import{H as X}from"./harvest-scheduler-BUE62zSJ.js";const Q=/([a-z0-9]+)$/i;function Y(e){if(!e)return;const r=e.match(Q);if(r)return r[1]}var Z=/^\n+|\n+$/g,M=65530;function x(e){return ee(e).replace(Z,"")}function ee(e){var r;if(e.length>100){var t=e.length-100;r=e.slice(0,50).join(`
`),r+=`
< ...truncated `+t+` lines... >
`,r+=e.slice(-50).join(`
`)}else r=e.join(`
`);return r}function re(e){return e.length>M?e.substr(0,M):e}function L(e){if(typeof e!="string")return"";const r=O(e),t=O(P);return r===t?"<inline>":r}var te=/function (.+?)\s*\(/,se=/^\s*at (?:((?:\[object object\])?(?:[^(]*\([^)]*\))*[^()]*(?: \[as \S+\])?) )?\(?((?:file|http|https|chrome-extension):.*?)?:(\d+)(?::(\d+))?\)?\s*$/i,ae=/^\s*(?:(\S*|global code)(?:\(.*?\))?@)?((?:file|http|https|chrome|safari-extension).*?):(\d+)(?::(\d+))?\s*$/i,ne=/^\s*at .+ \(eval at \S+ \((?:(?:file|http|https):[^)]+)?\)(?:, [^:]*:\d+:\d+)?\)$/i,oe=/^\s*at Function code \(Function code:\d+:\d+\)\s*/i;function ie(e){var r=null;try{if(r=ce(e),r)return r}catch{}try{if(r=le(e),r)return r}catch{}try{if(r=de(e),r)return r}catch{}return{mode:"failed",stackString:"",frames:[]}}function ce(e){if(!e.stack)return null;var r=e.stack.split(`
`).reduce(ue,{frames:[],stackLines:[],wrapperSeen:!1});return r.frames.length?{mode:"stack",name:e.name||y(e),message:e.message,stackString:x(r.stackLines),frames:r.frames}:null}function ue(e,r){let t=fe(r);if(!t)return e.stackLines.push(r),e;if(he(t.func)&&(e.wrapperSeen=!0),!e.wrapperSeen){let s=L(t.url);s!==t.url&&(r=r.replace(t.url,s),t.url=s),e.stackLines.push(r),e.frames.push(t)}return e}function fe(e){var r=e.match(ae);if(r||(r=e.match(se)),r)return{url:r[2],func:r[1]!=="Anonymous function"&&r[1]!=="global code"&&r[1]||null,line:+r[3],column:r[4]?+r[4]:null};if(e.match(ne)||e.match(oe)||e==="anonymous")return{func:"evaluated code"}}function le(e){if(!("line"in e))return null;var r=e.name||y(e);if(!e.sourceURL)return{mode:"sourceline",name:r,message:e.message,stackString:r+": "+e.message+`
    in evaluated code`,frames:[{func:"evaluated code"}]};var t=L(e.sourceURL),s=r+": "+e.message+`
    at `+t;return e.line&&(s+=":"+e.line,e.column&&(s+=":"+e.column)),{mode:"sourceline",name:r,message:e.message,stackString:s,frames:[{url:t,line:e.line,column:e.column}]}}function de(e){var r=e.name||y(e);return r?{mode:"nameonly",name:r,message:e.message,stackString:r+": "+e.message,frames:[]}:null}function y(e){var r=te.exec(String(e.constructor));return r&&r.length>1?r[1]:"unknown"}function he(e){return e&&e.indexOf("nrWrapper")>=0}function m(e){var r=0,t;if(!e||!e.length)return r;for(var s=0;s<e.length;s++)t=e.charCodeAt(s),r=(r<<5)-r+t,r=r|0;return r}var k,_;class ge extends K{constructor(t,s){var a;super(t,s,F);T(this,k);a=this,this.stackReported={},this.observedAt={},this.pageviewReported={},this.bufferedErrorsUnderSpa={},this.currentBody=void 0,this.errorOnPage=!1,this.ee.on("interactionDone",(n,u)=>this.onInteractionDone(n,u)),I("err",function(){return a.storeError(...arguments)},this.featureName,this.ee),I("ierr",function(){return a.storeError(...arguments)},this.featureName,this.ee),I("softNavFlush",(n,u,p)=>this.onSoftNavNotification(n,u,p),this.featureName,this.ee);const c=D(this.agentIdentifier,"jserrors.harvestTimeSeconds")||10,o=new X("jserrors",{onFinished:function(){return a.onHarvestFinished(...arguments)}},this);o.harvest.on("jserrors",function(){return a.onHarvestStarted(...arguments)}),this.ee.on("drain-".concat(this.featureName),()=>{this.blocked||o.startTimer(c)}),I("block-err",()=>{this.blocked=!0,o.stopTimer(!0)},this.featureName,this.ee),this.drain()}onHarvestStarted(t){var s=this.aggregator.take(["err","ierr","xhr"]);t.retry&&(this.currentBody=s);var a={body:s,qs:{}},c=g(B(this.agentIdentifier).releaseIds);return c!=="{}"&&(a.qs.ri=c),s&&s.err&&s.err.length&&!this.errorOnPage&&(a.qs.pve="1",this.errorOnPage=!0),a}onHarvestFinished(t){t.retry&&this.currentBody&&(A(this.currentBody,(s,a)=>{for(var c=0;c<a.length;c++){var o=a[c],n=this.getBucketName(s,o.params,o.custom);this.aggregator.merge(s,n,o.metrics,o.params,o.custom)}}),this.currentBody=null)}nameHash(t){return m("".concat(t.exceptionClass,"_").concat(t.message,"_").concat(t.stack_trace||t.browser_stack_hash))}getBucketName(t,s,a){return t==="xhr"?m(g(s))+":"+m(g(a)):this.nameHash(s)+":"+m(g(a))}buildCanonicalStackString(t){for(var s="",a=0;a<t.frames.length;a++){var c=t.frames[a],o=Y(c.func);s&&(s+=`
`),o&&(s+=o+"@"),typeof c.url=="string"&&(s+=c.url),c.line&&(s+=":"+c.line)}return s}storeError(t,s,a,c){var v,U,w,R,j,H;s=s||G();const o=B(this.agentIdentifier);let n;if(!a&&o.onerror&&(n=o.onerror(t),n&&!(typeof n.group=="string"&&n.group.length)))return;var u=ie(t),p=this.buildCanonicalStackString(u);const i={stackHash:m(p),exceptionClass:u.name,request_uri:(v=W)==null?void 0:v.location.pathname};u.message&&(i.message=""+u.message),n!=null&&n.group&&(i.errorGroup=n.group);var l=m("".concat(u.name,"_").concat(u.message,"_").concat(u.stackString));this.stackReported[l]?i.browser_stack_hash=m(u.stackString):(this.stackReported[l]=!0,i.stack_trace=re(u.stackString),this.observedAt[l]=o.offset+s),i.releaseIds=g(o.releaseIds),this.pageviewReported[l]||(i.pageview=1,this.pageviewReported[l]=!0),(w=(U=o==null?void 0:o.session)==null?void 0:U.state)!=null&&w.sessionReplayMode&&(i.hasReplay=!0),i.firstOccurrenceTimestamp=this.observedAt[l];var S=a?"ierr":"err",h={time:s};const f=[S,l,i,h,c];if(N("errorAgg",f,void 0,b.sessionTrace,this.ee),N("errorAgg",f,void 0,b.sessionReplay,this.ee),this.blocked)return;!!((R=V(this.agentIdentifier))!=null&&R.features[b.softNav])?N("jserror",[i,s],void 0,b.softNav,this.ee):N("errorAgg",f,void 0,b.spa,this.ee),i.browserInteractionId&&!i._softNavFinished?((j=this.bufferedErrorsUnderSpa)[H=i.browserInteractionId]??(j[H]=[]),this.bufferedErrorsUnderSpa[i.browserInteractionId].push(f)):i._interactionId!=null?(this.bufferedErrorsUnderSpa[i._interactionId]=this.bufferedErrorsUnderSpa[i._interactionId]||[],this.bufferedErrorsUnderSpa[i._interactionId].push(f)):E(this,k,_).call(this,f,i.browserInteractionId!==void 0,i._softNavAttributes)}onInteractionDone(t,s){!this.bufferedErrorsUnderSpa[t.id]||this.blocked||(this.bufferedErrorsUnderSpa[t.id].forEach(a=>{var c={};const o=a[4];A(t.root.attrs.custom,l),A(o,l);var n=a[2];s&&(n.browserInteractionId=t.root.attrs.id,n._interactionNodeId&&(n.parentNodeId=n._interactionNodeId.toString())),delete n._interactionId,delete n._interactionNodeId;var u=s?a[1]+t.root.attrs.id:a[1],p=m(g(c)),i=u+":"+p;this.aggregator.store(a[0],i,n,a[3],c);function l(S,h){c[S]=h&&typeof h=="object"?g(h):h}}),delete this.bufferedErrorsUnderSpa[t.id])}onSoftNavNotification(t,s,a){var c;this.blocked||((c=this.bufferedErrorsUnderSpa[t])==null||c.forEach(o=>E(this,k,_).call(this,o,s,a)),delete this.bufferedErrorsUnderSpa[t])}}k=new WeakSet,_=function(t,s){let a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},[c,o,n,u,p]=t;const i={};s?(Object.entries(a).forEach(f=>{let[d,v]=f;return h(d,v)}),o+=n.browserInteractionId,delete n._softNavAttributes,delete n._softNavFinished):(Object.entries(J(this.agentIdentifier).jsAttributes).forEach(f=>{let[d,v]=f;return h(d,v)}),delete n.browserInteractionId),p&&Object.entries(p).forEach(f=>{let[d,v]=f;return h(d,v)});const l=m(g(i)),S=o+":"+l;this.aggregator.store(c,S,n,u,i);function h(f,d){i[f]=d&&typeof d=="object"?g(d):d}},C(ge,"featureName",F);export{ge as Aggregate};
