var Ft=Object.defineProperty;var Lt=(l,r,u)=>r in l?Ft(l,r,{enumerable:!0,configurable:!0,writable:!0,value:u}):l[r]=u;var ct=(l,r,u)=>(Lt(l,typeof r!="symbol"?r+"":r,u),u);import{a1 as Ct,b as It,m as rt,z as at,p as nt,a4 as bt,g as Z,q as c,a5 as ut,a6 as Rt,a3 as Pt,a7 as ht,a8 as St,h as At,F as lt,S as kt,a9 as yt}from"./index-BfuMbHu1.js";import{a as ft}from"./deny-list-CM38xUZk.js";import{n as Ut}from"./nav-timing-DZL8I-f8.js";import{H as _t}from"./harvest-scheduler-BUE62zSJ.js";import{c as tt,A as jt}from"./aggregate-base-TAWkHkou.js";import{g as dt,n as v,a as b,b as mt}from"./bel-serializer-CZVfuImm.js";import{f as wt,a as Ot}from"./first-paint-B3pa43Fd.js";var Ht=128,zt=0;function st(l,r,u,t){Object.defineProperty(this,"interaction",{value:l,writable:!0}),this.parent=r,this.id=++zt,this.type=u,this.children=[],this.end=null,this.jsEnd=this.start=t,this.jsTime=0,this.attrs={},this.cancelled=!1}var K=st.prototype;K.child=function(r,u,t,g){var o=this.interaction;if(o.end||o.nodes>=Ht)return null;o.onNodeAdded(this);var s=new st(o,this,r,u);return s.attrs.name=t,o.nodes++,g||o.remaining++,s};K.callback=function(r,u){var t=this;t.jsTime+=r,u>t.jsEnd&&(t.jsEnd=u,t.interaction.lastCb=u)};K.cancel=function(){this.cancelled=!0;var r=this.interaction;r.remaining--};K.finish=function(r){var u=this;if(u.end)return;u.end=r;let t=u.parent;for(;t!=null&&t.cancelled;)t=t.parent;t&&t.children.push(u),u.parent=null;var g=this.interaction;g.remaining--,g.lastFinish=r,g.checkFinish()};var Nt=Ct.ST,Mt=Ct.CT,vt={};function $(l,r,u,t,g,o){this.agentIdentifier=o,this.ee=It.get(o),vt[o]=0,this.id=++vt[o],this.eventName=l,this.nodes=0,this.remaining=0,this.finishTimer=null,this.checkingFinish=!1,this.lastCb=this.lastFinish=r,this.handlers=[],this.onFinished=g,this.done=!1;var s=this.root=new st(this,null,"interaction",r),d=s.attrs;d.trigger=l,d.initialPageURL=rt(o).origin,d.oldRoute=t,d.newURL=d.oldURL=u,d.custom={},d.store={}}var j=$.prototype;j.checkFinish=function(){var r=this;if(r.remaining>0){r._resetFinishCheck();return}r.checkingFinish||r.root.end===null&&(r._resetFinishCheck(),r.checkingFinish=!0,r.finishTimer=Nt(()=>{r.checkingFinish=!1,r.finishTimer=Nt(()=>{r.finishTimer=null,r.remaining<=0&&r.finish()},1)},0))};j.setNewURL=function(r){this.root.attrs.newURL=r};j.setNewRoute=function(r){this.root.attrs.newRoute=r};j.onNodeAdded=function(){this._resetFinishCheck()};j._resetFinishCheck=function(){this.finishTimer&&(Mt(this.finishTimer),this.finishTimer=null,this.checkingFinish=!1)};j.finish=function(){var r=this,u=r.root;if(u.end===null){var t=Math.max(r.lastCb,r.lastFinish),g=u.attrs,o=g.custom;this.onFinished&&this.onFinished(this),at(nt(r.agentIdentifier).jsAttributes,function(s,d){s in o||(o[s]=d)}),u.end=t,r.ee.emit("interaction",[this])}};class Bt extends bt{constructor(r){super(r),this.firstTimestamp=void 0}serializeMultiple(r,u,t){const g=nt(this.sharedContext.agentIdentifier);var o=dt(this.sharedContext.agentIdentifier),s="bel.7";return r.forEach(d=>{s+=";"+this.serializeInteraction(d.root,u,t,d.routeChange,o,g)}),this.firstTimestamp=void 0,s}serializeSingle(r,u,t,g){const o=nt(this.sharedContext.agentIdentifier);var s=dt(this.sharedContext.agentIdentifier),d="bel.7;"+this.serializeInteraction(r,u,t,g,s,o);return this.firstTimestamp=void 0,d}serializeInteraction(r,u,t,g,o,s){u=u||0;var d=r.attrs.trigger==="initialPageLoad",P={interaction:1,ajax:2,customTracer:4},w=!0;const B=(h,C)=>{if(h.type==="customEnd")return C.push([3,v(h.end-this.firstTimestamp)]);var k=h.type,S=P[k],y=h.start,U=h.children.length,O=0,H=s.atts,D=d&&t.length&&S===1,F=[],m=h.attrs,q=m.metrics,I=m.params,Q=s.queueTime,N=s.applicationTime;typeof this.firstTimestamp>"u"?(y+=u,this.firstTimestamp=y):y-=this.firstTimestamp;var L=[v(y),v(h.end-h.start),v(h.jsEnd-h.end),v(h.jsTime)];switch(S){case 1:L[2]=v(h.jsEnd-this.firstTimestamp),L.push(o(m.trigger),o(tt(m.initialPageURL,w)),o(tt(m.oldURL,w)),o(tt(m.newURL,w)),o(m.customName),d?"":g?1:2,b(d&&Q,v,!0)+b(d&&N,v,!0)+b(m.oldRoute,o,!0)+b(m.newRoute,o,!0)+o(m.id),o(h.id),b(m.firstPaint,v,!0)+b(m.firstContentfulPaint,v,!1));var G=mt(m.custom,o);F=F.concat(G),O=G.length,H&&(U++,F.push("a,"+o(H)));break;case 2:if(L.push(o(I.method),v(I.status),o(I.host),o(I.pathname),v(q.txSize),v(q.rxSize),m.isFetch?1:m.isJSONP?2:"",o(h.id),b(h.dt&&h.dt.spanId,o,!0)+b(h.dt&&h.dt.traceId,o,!0)+b(h.dt&&h.dt.timestamp,v,!1)),Object.keys((I==null?void 0:I.gql)||{}).length){var J=mt(I.gql,o);F=F.concat(J),O=J.length}break;case 4:var W=m.tracedTime;L.push(o(m.name),b(W,v,!0)+o(h.id));break}for(var z=0;z<h.children.length;z++)B(h.children[z],F);if(L.unshift(v(S),v(U+=O)),C.push(L),U&&C.push(F.join(";")),D){var _=",",e="b",i=0;at(t.slice(1,21),function(n,a){a!==void 0?(e+=_+v(a-i),_=",",i=a):(e+=_+"!",_="")}),C.push(e)}else S===1&&C.push("");return C};return B(r,[]).join(";")}}const{FEATURE_NAME:pt,INTERACTION_EVENTS:gt,MAX_TIMER_BUDGET:V,FN_START:A,FN_END:Tt,CB_START:X,INTERACTION_API:R,REMAINING:x,INTERACTION:p,SPA_NODE:T,JSONP_NODE:Y,FETCH_START:et,FETCH_DONE:Et,FETCH_BODY:xt,JSONP_END:it,originalSetTimeout:Dt}=yt;class qt extends jt{constructor(r,u){super(r,u,pt),this.state={initialPageURL:rt(r).origin,lastSeenUrl:rt(r).origin,lastSeenRouteName:null,timerMap:{},timerBudget:V,currentNode:null,prevNode:null,nodeOnLastHashUpdate:null,initialPageLoad:null,pageLoaded:!1,childTime:0,depth:0,harvestTimeSeconds:Z(r,"spa.harvestTimeSeconds")||10,interactionsToHarvest:[],interactionsSent:[],disableSpaFix:(Z(r,"feature_flags")||[]).indexOf("disable-spa-fix")>-1},this.serializer=new Bt(this);const{state:t,serializer:g}=this;let{blocked:o}=this;const s=It.get(r),d=s.get("mutation"),P=s.get("promise"),w=s.get("history"),B=s.get("events"),h=s.get("timer"),C=s.get("fetch"),k=s.get("jsonp"),S=s.get("xhr"),y=s.get("tracer"),U=new _t("events",{onFinished:J,retryDelay:t.harvestTimeSeconds},{agentIdentifier:r,ee:s});if(U.harvest.on("events",G),c("block-spa",()=>{o=!0,U.stopTimer(!0)},this.featureName,s),!_())return;t.initialPageLoad=new $("initialPageLoad",0,t.lastSeenUrl,t.lastSeenRouteName,L,r),t.initialPageLoad.save=!0,t.prevInteraction=t.initialPageLoad,t.currentNode=t.initialPageLoad.root,t.initialPageLoad[x]++,c(A,H,this.featureName,s),c(X,H,this.featureName,P);var O={getCurrentNode:Q,setCurrentNode:N};c("spa-register",function(e){typeof e=="function"&&e(O)},lt.spa,s);function H(){t.depth++,this.prevNode=t.currentNode,this.ct=t.childTime,t.childTime=0,t.timerBudget=V}c(Tt,D,this.featureName,s),c("cb-end",D,this.featureName,P);function D(){t.depth--;var e=this.jsTime||0,i=e-t.childTime;t.childTime=this.ct+e,t.currentNode&&(t.currentNode.callback(i,this[Tt]),this.isTraced&&(t.currentNode.attrs.tracedTime=i)),this.jsTime=t.currentNode?0:i,N(this.prevNode),this.prevNode=null,t.timerBudget=V}c(A,function(e,i){var n=e[0],a=n.type,f=n["__nrNode:".concat(ut)];if(!t.pageLoaded&&(a==="load"&&i===window||Rt)&&(t.pageLoaded=!0,this.prevNode=t.currentNode=null,t.initialPageLoad&&(f=t.initialPageLoad.root,t.initialPageLoad[x]=0,Dt(function(){gt.push("popstate")}))),f)N(f);else if(a==="hashchange")N(t.nodeOnLastHashUpdate),t.nodeOnLastHashUpdate=null;else if(i instanceof XMLHttpRequest)N(s.context(i).spaNode);else if(!t.currentNode&&gt.indexOf(a)!==-1){var E=new $(a,this[A],t.lastSeenUrl,t.lastSeenRouteName,L,r);if(t.prevInteraction=E,N(E.root),a==="click"){var M=W(n.target);M&&(t.currentNode.attrs.custom.actionText=M)}}n["__nrNode:".concat(ut)]=t.currentNode},this.featureName,B),c("setTimeout-end",function(i,n,a){!t.currentNode||t.timerBudget-this.timerDuration<0||i&&!(i[0]instanceof Function)||(t.currentNode[p][x]++,this.timerId=a,t.timerMap[a]=t.currentNode,this.timerBudget=t.timerBudget-50)},this.featureName,h),c("clearTimeout-start",function(i){var n=i[0],a=t.timerMap[n];if(a){var f=a[p];f[x]--,f.checkFinish(),delete t.timerMap[n]}},this.featureName,h),c(A,function(){t.timerBudget=this.timerBudget||V;var e=this.timerId,i=t.timerMap[e];N(i),delete t.timerMap[e],i&&i[p][x]--},this.featureName,h),c(A,function(){N(this[T])},this.featureName,S),c("new-xhr",function(){if(!t.disableSpaFix&&!t.currentNode&&t.prevInteraction&&!t.prevInteraction.ignored){const e=t.prevInteraction;t.currentNode=e.root,e.root.end=null}t.currentNode&&(this[T]=t.currentNode.child("ajax",null,null,!0))},this.featureName,S),c("send-xhr-start",function(){var e=this[T];e&&!this.sent&&(this.sent=!0,e.dt=this.dt,e.jsEnd=e.start=this.startTime,e[p][x]++)},this.featureName,S),c("xhr-resolved",function(){var e=this[T];if(e){if(!ft(this.params)){e.cancel();return}var i=e.attrs;i.params=this.params,i.metrics=this.metrics,e.finish(this.endTime),this.currentNode&&this.currentNode.interaction&&this.currentNode.interaction.checkFinish()}},this.featureName,s),c("new-jsonp",function(e){if(t.currentNode){var i=this[Y]=t.currentNode.child("ajax",this[et]);i.start=this["new-jsonp"],this.url=e,this.status=null}},this.featureName,k),c("cb-start",function(e){var i=this[Y];i&&(N(i),this.status=200)},this.featureName,k),c("jsonp-error",function(){var e=this[Y];e&&(N(e),this.status=0)},this.featureName,k),c(it,function(){var e=this[Y];if(e){if(this.status===null){e.cancel();return}var i=e.attrs,n=i.params={},a=Pt(this.url);n.method="GET",n.pathname=a.pathname,n.host=a.hostname+":"+a.port,n.status=this.status,i.metrics={txSize:0,rxSize:0},i.isJSONP=!0,e.jsEnd=this[it],e.jsTime=this[X]?this[it]-this[X]:0,e.finish(e.jsEnd)}},this.featureName,k),c(et,function(e,i){if(e){if(!t.disableSpaFix&&!t.currentNode&&t.prevInteraction&&!t.prevInteraction.ignored){const n=t.prevInteraction;t.currentNode=n.root,n.root.end=null}t.currentNode&&(this[T]=t.currentNode.child("ajax",this[et]),i&&this[T]&&(this[T].dt=i))}},this.featureName,C),c(xt+"start",function(e){t.currentNode&&(this[T]=t.currentNode,t.currentNode[p][x]++)},this.featureName,C),c(xt+"end",function(e,i,n){var a=this[T];a&&a[p][x]--},this.featureName,C),c(Et,function(e,i){var n=this[T];if(n){if(e||!ft(this.params)){n.cancel();return}var a=n.attrs;a.params=this.params,a.metrics={txSize:this.txSize,rxSize:this.rxSize},a.isFetch=!0,n.finish(this[Et])}},this.featureName,C),c("newURL",function(e,i){if(t.currentNode)t.currentNode[p].setNewURL(e);else if(t.prevInteraction&&!t.prevInteraction.ignored){const n=t.prevInteraction;n.setNewURL(e),n.root.end=null,N(n.root)}t.currentNode&&(t.lastSeenUrl!==e&&(t.currentNode[p].routeChange=!0),i&&(t.nodeOnLastHashUpdate=t.currentNode)),t.lastSeenUrl=e},this.featureName,w),k.on("dom-start",function(e){if(!t.currentNode)return;var i=e[0],n=i&&i.nodeName==="SCRIPT"&&i.src!=="",a=t.currentNode.interaction;n&&(a[x]++,i.addEventListener("load",f,ht(!1)),i.addEventListener("error",E,ht(!1)));function f(){a[x]--,a.checkFinish()}function E(){a[x]--,a.checkFinish()}}),c(A,function(){N(t.prevNode)},this.featureName,d),c("resolve-start",I,this.featureName,P),c("executor-err",I,this.featureName,P),c("propagate",q,this.featureName,P),c(X,function(){var e=this.getCtx?this.getCtx():this;N(e[T])},this.featureName,P),c(R+"get",function(e){var n,a,f,E,M,ot;var i;(n=t==null?void 0:t.currentNode)!=null&&n[p]?i=this.ixn=t.currentNode[p]:((a=t==null?void 0:t.prevNode)==null?void 0:a.end)===null&&((ot=(M=(E=(f=t==null?void 0:t.prevNode)==null?void 0:f[p])==null?void 0:E.root)==null?void 0:M[p])==null?void 0:ot.eventName)!=="initialPageLoad"?i=this.ixn=t.prevNode[p]:i=this.ixn=new $("api",e,t.lastSeenUrl,t.lastSeenRouteName,L,r),t.currentNode||(i.checkFinish(),t.depth&&N(i.root))},this.featureName,s),c(R+"actionText",function(e,i){var n=this.ixn.root.attrs.custom;i&&(n.actionText=i)},this.featureName,s),c(R+"setName",function(e,i,n){var a=this.ixn.root.attrs;i&&(a.customName=i),n&&(a.trigger=n)},this.featureName,s),c(R+"setAttribute",function(e,i,n){this.ixn.root.attrs.custom[i]=n},this.featureName,s),c(R+"end",function(e){var i=this.ixn,n=m(i);N(null),n.child("customEnd",e).finish(e),i.finish()},this.featureName,s),c(R+"ignore",function(e){this.ixn.ignored=!0},this.featureName,s),c(R+"save",function(e){this.ixn.save=!0},this.featureName,s),c(R+"tracer",function(e,i,n){var a=this.ixn,f=m(a),E=s.context(n);if(!i)return E.inc=++a[x],E[T]=f;E[T]=f.child("customTracer",e,i)},this.featureName,s),c(A,F,this.featureName,y),c("no-"+A,F,this.featureName,y);function F(e,i,n){var a=this[T];if(a){var f=a[p],E=this.inc;this.isTraced=!0,E?f[x]--:a&&a.finish(e),n?N(a):f.checkFinish()}}c(R+"getContext",function(e,i){var n=this.ixn.root.attrs.store;setTimeout(function(){i(n)},0)},this.featureName,s),c(R+"onEnd",function(e,i){this.ixn.handlers.push(i)},this.featureName,s),c("api-routeName",function(e,i){t.lastSeenRouteName=i,t.currentNode&&t.currentNode[p].setNewRoute(i)},this.featureName,s);function m(e){return t.currentNode&&t.currentNode[p]===e?t.currentNode:e.root}function q(e,i){(i||!this[T])&&(this[T]=t.currentNode)}function I(){this.resolved||(this.resolved=!0,this[T]=t.currentNode)}function Q(){return t.currentNode}function N(e){!t.pageLoaded&&!e&&t.initialPageLoad&&(e=t.initialPageLoad.root),t.currentNode&&t.currentNode[p].checkFinish(),t.prevNode=t.currentNode,t.currentNode=e&&!e[p].root.end?e:null}function L(e){e===t.initialPageLoad&&(t.initialPageLoad=null);var i=e.root,n=i.attrs;t.currentNode=i,at(e.handlers,function(a,f){f(n.store)}),N(null)}function G(e){if(t.interactionsToHarvest.length===0||o)return{};var i=g.serializeMultiple(t.interactionsToHarvest,0,Ut);return e.retry&&t.interactionsToHarvest.forEach(function(n){t.interactionsSent.push(n)}),t.interactionsToHarvest=[],{body:{e:i}}}function J(e){e.sent&&e.retry&&t.interactionsSent.length>0&&(t.interactionsSent.forEach(function(i){t.interactionsToHarvest.unshift(i)}),t.interactionsSent=[])}s.on("errorAgg",function(e,i,n,a){t.currentNode&&(n._interactionId=t.currentNode.interaction.id,t.currentNode.type&&t.currentNode.type!=="interaction"&&(n._interactionNodeId=t.currentNode.id))}),s.on("interaction",z);function W(e){var i=e.tagName.toLowerCase(),n=["a","button","input"],a=n.indexOf(i)!==-1;if(a)return e.title||e.value||e.innerText}function z(e){var n,a,f,E;if(e.ignored||!e.save&&!e.routeChange){s.emit("interactionDone",[e,!1]);return}t.prevInteraction===e&&(t.prevInteraction=null),e.root.attrs.id=St(),e.root.attrs.trigger==="initialPageLoad"&&(e.root.attrs.firstPaint=wt.current.value,e.root.attrs.firstContentfulPaint=Ot.current.value),s.emit("interactionDone",[e,!0]),t.interactionsToHarvest.push(e);let i;((a=(n=e.root)==null?void 0:n.attrs)==null?void 0:a.trigger)==="initialPageLoad"?i="InitialPageLoad":e.routeChange?i="RouteChange":i="Custom",At(kt,["Spa/Interaction/".concat(i,"/Duration/Ms"),Math.max((((f=e.root)==null?void 0:f.end)||0)-(((E=e.root)==null?void 0:E.start)||0),0)],void 0,lt.metrics,s),U.scheduleHarvest(0)}function _(){var e=Z(r,"spa.enabled");return e!==!1}this.drain()}}ct(qt,"featureName",pt);export{qt as Aggregate};
