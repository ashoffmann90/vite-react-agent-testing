var B=Object.defineProperty;var E=(i,e,t)=>e in i?B(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var l=(i,e,t)=>(E(i,typeof e!="symbol"?e+"":e,t),t);import{O as A,F as o,T as y,i as F,p as j,m as w,E as m,s as T,U as x,l as N}from"./index-DYkS4CO9.js";import{a as b,b as v}from"./nav-timing-DZL8I-f8.js";import{A as R,H as M}from"./aggregate-base-f-EEGmdR.js";import{f as k,a as P}from"./first-paint-5kt2QkY_.js";import{t as C}from"./time-to-first-byte-D3ljdkzf.js";function q(i){const e=[],t=A();try{Object.keys(t.initializedAgents[i].features).forEach(r=>{switch(r){case o.ajax:e.push("xhr");break;case o.jserrors:e.push("err");break;case o.pageAction:e.push("ins");break;case o.sessionTrace:e.push("stn");break;case o.softNav:case o.spa:e.push("spa");break}})}catch{}return e}class I extends R{constructor(e,t){super(e,t,y),this.timeToFirstByte=0,this.firstByteToWindowLoad=0,this.firstByteToDomContent=0,F?C.subscribe(r=>{let{value:a,entries:f}=r;const u=f[0];this.timeToFirstByte=Math.max(a,this.timeToFirstByte),this.firstByteToWindowLoad=Math.max(Math.round(u.loadEventEnd-this.timeToFirstByte),this.firstByteToWindowLoad),this.firstByteToDomContent=Math.max(Math.round(u.domContentLoadedEventEnd-this.timeToFirstByte),this.firstByteToDomContent),this.sendRum()}):this.sendRum()}sendRum(){var u,d,g;const e=j(this.agentIdentifier),t=w(this.agentIdentifier),r=new M(this);if(!e.beacon)return;e.queueTime&&this.aggregator.store("measures","qt",{value:e.queueTime}),e.applicationTime&&this.aggregator.store("measures","ap",{value:e.applicationTime}),this.aggregator.store("measures","be",{value:this.timeToFirstByte}),this.aggregator.store("measures","fe",{value:this.firstByteToWindowLoad}),this.aggregator.store("measures","dc",{value:this.firstByteToDomContent});const a={tt:e.ttGuid,us:e.user,ac:e.account,pr:e.product,af:q(this.agentIdentifier).join(","),...Object.entries(this.aggregator.get("measures")||{}).reduce((s,n)=>{var p;let[c,h]=n;return s[c]=(p=h.params)==null?void 0:p.value,s},{}),xx:e.extra,ua:e.userAttributes,at:e.atts};t.session&&(a.fsh=Number(t.session.isNew));let f;if(typeof e.jsAttributes=="object"&&Object.keys(e.jsAttributes).length>0&&(f={ja:e.jsAttributes}),m.performance){if(typeof PerformanceNavigationTiming<"u"){const s=(g=(d=(u=m)==null?void 0:u.performance)==null?void 0:d.getEntriesByType("navigation"))==null?void 0:g[0],n={timing:b(t.offset,s,{}),navigation:v(s,{})};a.perf=T(n)}else if(typeof PerformanceTiming<"u"){const s={timing:b(t.offset,m.performance.timing,{},!0),navigation:v(m.performance.navigation,{})};a.perf=T(s)}}a.fp=k.current.value,a.fcp=P.current.value,r.send({endpoint:"rum",payload:{qs:a,body:f},opts:{needResponse:!0,sendEmptyBody:!0},cbFinished:s=>{let{status:n,responseText:c}=s;if(n>=400||n===0){this.ee.abort();return}try{x(JSON.parse(c),this.agentIdentifier),this.drain()}catch(h){this.ee.abort(),N("RUM call failed. Agent shutting down.",h)}}})}}l(I,"featureName",y);export{I as Aggregate};
